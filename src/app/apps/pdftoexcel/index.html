<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF to Excel Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0f0d;
            --bg-secondary: #111916;
            --bg-card: #151d19;
            --fg: #e8f0ec;
            --fg-muted: #7a8f84;
            --accent: #00d47b;
            --accent-dim: #00a85f;
            --border: #243029;
            --error: #ff6b6b;
            --warning: #ffc857;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--fg);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Animated background */
        .bg-pattern {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .bg-pattern::before {
            content: '';
            position: absolute;
            width: 150%;
            height: 150%;
            top: -25%;
            left: -25%;
            background: 
                radial-gradient(ellipse 600px 400px at 20% 30%, rgba(0, 212, 123, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse 500px 500px at 80% 70%, rgba(0, 168, 95, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse 400px 300px at 50% 50%, rgba(0, 212, 123, 0.04) 0%, transparent 50%);
            animation: bgFloat 20s ease-in-out infinite;
        }

        @keyframes bgFloat {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(2%, 1%) rotate(1deg); }
            66% { transform: translate(-1%, 2%) rotate(-1deg); }
        }

        .grid-overlay {
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(0, 212, 123, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 212, 123, 0.03) 1px, transparent 1px);
            background-size: 60px 60px;
            mask-image: radial-gradient(ellipse at center, black 20%, transparent 70%);
        }

        /* Upload zone */
        .upload-zone {
            border: 2px dashed var(--border);
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .upload-zone::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(0, 212, 123, 0.05) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .upload-zone:hover,
        .upload-zone.drag-over {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 20px 40px -15px rgba(0, 212, 123, 0.2);
        }

        .upload-zone:hover::before,
        .upload-zone.drag-over::before {
            opacity: 1;
        }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dim) 100%);
            color: var(--bg-primary);
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent 0%, rgba(255,255,255,0.2) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -10px rgba(0, 212, 123, 0.5);
        }

        .btn-primary:hover::before {
            opacity: 1;
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--fg);
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            background: var(--bg-secondary);
        }

        /* Progress bar */
        .progress-container {
            background: var(--bg-secondary);
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--accent-dim), var(--accent), var(--accent-dim));
            background-size: 200% 100%;
            animation: progressShimmer 2s linear infinite;
            transition: width 0.3s ease-out;
        }

        @keyframes progressShimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* File card */
        .file-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .file-card:hover {
            border-color: var(--accent-dim);
            transform: translateY(-2px);
        }

        /* Table preview */
        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
        }

        .table-container table {
            border-collapse: collapse;
            width: 100%;
        }

        .table-container th {
            background: var(--bg-secondary);
            color: var(--accent);
            font-weight: 600;
            text-align: left;
            padding: 12px 16px;
            border-bottom: 2px solid var(--accent-dim);
        }

        .table-container td {
            padding: 10px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--fg-muted);
        }

        .table-container tr:hover td {
            background: rgba(0, 212, 123, 0.05);
            color: var(--fg);
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stagger-1 { animation-delay: 0.1s; opacity: 0; }
        .stagger-2 { animation-delay: 0.2s; opacity: 0; }
        .stagger-3 { animation-delay: 0.3s; opacity: 0; }

        /* Status indicator */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-dim);
        }

        /* Focus states */
        *:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Background -->
    <div class="bg-pattern">
        <div class="grid-overlay"></div>
    </div>

    <!-- Main Content -->
    <main class="relative z-10 min-h-screen px-4 py-8 md:py-12">
        <div class="max-w-5xl mx-auto">
            <!-- Header -->
            <header class="text-center mb-12 fade-in">
                <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-[var(--bg-card)] border border-[var(--border)] mb-6">
                    <span class="status-dot bg-[var(--accent)]"></span>
                    <span class="text-sm text-[var(--fg-muted)] mono">100% Free • No Upload Limits • Client-Side Processing</span>
                </div>
                <h1 class="text-4xl md:text-6xl font-bold mb-4 tracking-tight">
                    PDF to Excel<br>
                    <span class="text-[var(--accent)]">Converter</span>
                </h1>
                <p class="text-[var(--fg-muted)] text-lg max-w-xl mx-auto">
                    Extract tables from PDF files and convert them to Excel spreadsheets. 
                    All processing happens in your browser - your files never leave your device.
                </p>
            </header>

            <!-- Upload Section -->
            <section class="mb-8 fade-in stagger-1" id="uploadSection">
                <div class="upload-zone rounded-2xl p-8 md:p-12 text-center cursor-pointer" 
                     id="dropZone"
                     role="button"
                     tabindex="0"
                     aria-label="Upload PDF file">
                    <input type="file" id="fileInput" accept=".pdf" class="hidden" aria-hidden="true">
                    
                    <div class="mb-6">
                        <svg class="w-16 h-16 mx-auto text-[var(--accent)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                    </div>
                    
                    <h3 class="text-xl font-semibold mb-2">Drop your PDF here</h3>
                    <p class="text-[var(--fg-muted)] mb-4">or click to browse your files</p>
                    
                    <div class="inline-flex items-center gap-4 text-sm text-[var(--fg-muted)] mono">
                        <span class="flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            PDF files only
                        </span>
                        <span class="flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                            </svg>
                            Secure & Private
                        </span>
                    </div>
                </div>
            </section>

            <!-- Processing Section (Hidden by default) -->
            <section id="processingSection" class="hidden mb-8">
                <div class="file-card rounded-2xl p-6 mb-6">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-[var(--accent)] bg-opacity-10 flex items-center justify-center">
                            <svg class="w-6 h-6 text-[var(--accent)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 id="fileName" class="font-semibold truncate">document.pdf</h4>
                            <p id="fileSize" class="text-sm text-[var(--fg-muted)] mono">2.4 MB</p>
                        </div>
                        <button id="removeFile" class="p-2 rounded-lg hover:bg-[var(--bg-secondary)] transition-colors" aria-label="Remove file">
                            <svg class="w-5 h-5 text-[var(--fg-muted)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Progress -->
                <div id="progressContainer" class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-[var(--fg-muted)]">Processing...</span>
                        <span id="progressPercent" class="text-sm font-medium mono">0%</span>
                    </div>
                    <div class="progress-container h-2 rounded-full">
                        <div id="progressBar" class="progress-bar h-full rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="progressStatus" class="text-xs text-[var(--fg-muted)] mt-2 mono">Initializing...</p>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="text-center py-8 hidden">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-[var(--fg-muted)]">Analyzing document structure...</p>
                </div>
            </section>

            <!-- Results Section (Hidden by default) -->
            <section id="resultsSection" class="hidden">
                <!-- Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="file-card rounded-xl p-4 text-center">
                        <p id="statPages" class="text-2xl font-bold text-[var(--accent)]">0</p>
                        <p class="text-xs text-[var(--fg-muted)] uppercase tracking-wider">Pages</p>
                    </div>
                    <div class="file-card rounded-xl p-4 text-center">
                        <p id="statTables" class="text-2xl font-bold text-[var(--accent)]">0</p>
                        <p class="text-xs text-[var(--fg-muted)] uppercase tracking-wider">Tables Found</p>
                    </div>
                    <div class="file-card rounded-xl p-4 text-center">
                        <p id="statRows" class="text-2xl font-bold text-[var(--accent)]">0</p>
                        <p class="text-xs text-[var(--fg-muted)] uppercase tracking-wider">Rows</p>
                    </div>
                    <div class="file-card rounded-xl p-4 text-center">
                        <p id="statCells" class="text-2xl font-bold text-[var(--accent)]">0</p>
                        <p class="text-xs text-[var(--fg-muted)] uppercase tracking-wider">Cells</p>
                    </div>
                </div>

                <!-- Preview -->
                <div id="previewContainer" class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">Data Preview</h3>
                        <span id="previewInfo" class="text-sm text-[var(--fg-muted)] mono">Showing first 10 rows</span>
                    </div>
                    <div class="table-container rounded-xl overflow-hidden overflow-x-auto">
                        <table id="previewTable">
                            <thead id="previewHead"></thead>
                            <tbody id="previewBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="downloadBtn" class="btn-primary flex-1 px-6 py-4 rounded-xl font-semibold flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        Download Excel File
                    </button>
                    <button id="newFileBtn" class="btn-secondary px-6 py-4 rounded-xl font-medium">
                        Convert Another File
                    </button>
                </div>
            </section>

            <!-- Error Section -->
            <section id="errorSection" class="hidden">
                <div class="file-card rounded-2xl p-6 text-center border-[var(--error)]">
                    <svg class="w-12 h-12 mx-auto mb-4 text-[var(--error)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <h3 class="text-xl font-semibold mb-2">Conversion Failed</h3>
                    <p id="errorMessage" class="text-[var(--fg-muted)] mb-4">Unable to process the PDF file.</p>
                    <button id="retryBtn" class="btn-primary px-6 py-3 rounded-xl">
                        Try Again
                    </button>
                </div>
            </section>

            <!-- Features -->
            <section class="mt-16 fade-in stagger-3">
                <h2 class="text-2xl font-bold text-center mb-8">How It Works</h2>
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="file-card rounded-xl p-6">
                        <div class="w-10 h-10 rounded-lg bg-[var(--accent)] bg-opacity-10 flex items-center justify-center mb-4">
                            <span class="text-[var(--accent)] font-bold">1</span>
                        </div>
                        <h3 class="font-semibold mb-2">Upload PDF</h3>
                        <p class="text-sm text-[var(--fg-muted)]">Drag and drop or select your PDF file containing tables you want to extract.</p>
                    </div>
                    <div class="file-card rounded-xl p-6">
                        <div class="w-10 h-10 rounded-lg bg-[var(--accent)] bg-opacity-10 flex items-center justify-center mb-4">
                            <span class="text-[var(--accent)] font-bold">2</span>
                        </div>
                        <h3 class="font-semibold mb-2">Auto Detection</h3>
                        <p class="text-sm text-[var(--fg-muted)]">Our algorithm analyzes the document structure and identifies tabular data automatically.</p>
                    </div>
                    <div class="file-card rounded-xl p-6">
                        <div class="w-10 h-10 rounded-lg bg-[var(--accent)] bg-opacity-10 flex items-center justify-center mb-4">
                            <span class="text-[var(--accent)] font-bold">3</span>
                        </div>
                        <h3 class="font-semibold mb-2">Download Excel</h3>
                        <p class="text-sm text-[var(--fg-muted)]">Get your data in a clean Excel file ready for editing, analysis, or reporting.</p>
                    </div>
                </div>
            </section>

            <!-- Footer -->
            <footer class="mt-16 text-center text-sm text-[var(--fg-muted)]">
                <p>All processing happens locally in your browser. Your files are never uploaded to any server.</p>
            </footer>
        </div>
    </main>

    <script>
        // Initialize PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // State
        let extractedData = [];
        let currentFileName = 'document';

        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const processingSection = document.getElementById('processingSection');
        const resultsSection = document.getElementById('resultsSection');
        const errorSection = document.getElementById('errorSection');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const progressStatus = document.getElementById('progressStatus');
        const progressContainer = document.getElementById('progressContainer');
        const loadingState = document.getElementById('loadingState');
        const previewTable = document.getElementById('previewTable');
        const previewHead = document.getElementById('previewHead');
        const previewBody = document.getElementById('previewBody');
        const downloadBtn = document.getElementById('downloadBtn');
        const newFileBtn = document.getElementById('newFileBtn');
        const removeFile = document.getElementById('removeFile');
        const retryBtn = document.getElementById('retryBtn');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');

        // Stats elements
        const statPages = document.getElementById('statPages');
        const statTables = document.getElementById('statTables');
        const statRows = document.getElementById('statRows');
        const statCells = document.getElementById('statCells');

        // File drop handlers
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                fileInput.click();
            }
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // Button handlers
        removeFile.addEventListener('click', resetApp);
        newFileBtn.addEventListener('click', resetApp);
        retryBtn.addEventListener('click', resetApp);
        downloadBtn.addEventListener('click', downloadExcel);

        function handleFile(file) {
            currentFileName = file.name.replace('.pdf', '');
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);

            showSection('processing');
            
            processPDF(file);
        }

        async function processPDF(file) {
            try {
                updateProgress(0, 'Loading PDF file...');
                
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                const numPages = pdf.numPages;
                let allTables = [];
                let totalRows = 0;
                let totalCells = 0;

                updateProgress(10, `Found ${numPages} pages, extracting content...`);

                for (let i = 1; i <= numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    
                    updateProgress(10 + (i / numPages) * 60, `Processing page ${i} of ${numPages}...`);
                    
                    const tables = extractTablesFromText(textContent.items, i);
                    if (tables.length > 0) {
                        allTables = allTables.concat(tables);
                        tables.forEach(table => {
                            totalRows += table.data.length;
                            totalCells += table.data.reduce((sum, row) => sum + row.length, 0);
                        });
                    }
                }

                updateProgress(80, 'Structuring data...');

                if (allTables.length === 0) {
                    throw new Error('No tables found in this PDF. The PDF may contain scanned images or non-tabular data.');
                }

                // Combine all tables into one dataset
                extractedData = [];
                allTables.forEach((table, index) => {
                    if (index > 0) {
                        extractedData.push([]); // Empty row between tables
                    }
                    extractedData = extractedData.concat(table.data);
                });

                updateProgress(100, 'Complete!');

                // Update stats
                animateNumber(statPages, numPages);
                animateNumber(statTables, allTables.length);
                animateNumber(statRows, totalRows);
                animateNumber(statCells, totalCells);

                // Show preview
                renderPreview();

                setTimeout(() => showSection('results'), 500);

            } catch (error) {
                console.error('Error processing PDF:', error);
                showError(error.message || 'Failed to process PDF file');
            }
        }

        function extractTablesFromText(items, pageNum) {
            // Group items by their Y position (rows)
            const rows = new Map();
            let minY = Infinity;
            let maxY = -Infinity;

            items.forEach(item => {
                if (!item.str.trim()) return;
                
                // Round Y position to group nearby items
                const yKey = Math.round(item.transform[5] / 5) * 5;
                
                if (!rows.has(yKey)) {
                    rows.set(yKey, []);
                }
                rows.get(yKey).push({
                    text: item.str,
                    x: item.transform[4],
                    y: item.transform[5],
                    width: item.width
                });

                minY = Math.min(minY, item.transform[5]);
                maxY = Math.max(maxY, item.transform[5]);
            });

            // Sort rows by Y position (top to bottom)
            const sortedRows = Array.from(rows.entries())
                .sort((a, b) => b[0] - a[0])
                .map(entry => {
                    // Sort items in each row by X position (left to right)
                    return entry[1].sort((a, b) => a.x - b.x);
                });

            if (sortedRows.length < 2) return [];

            // Detect table structure based on column alignment
            const columnPositions = detectColumns(sortedRows);
            
            if (columnPositions.length < 2) return [];

            // Build table data
            const tableData = sortedRows.map(row => {
                const cells = new Array(columnPositions.length).fill('');
                
                row.forEach(item => {
                    // Find the closest column for this item
                    let colIndex = 0;
                    let minDist = Infinity;
                    
                    columnPositions.forEach((pos, idx) => {
                        const dist = Math.abs(item.x - pos);
                        if (dist < minDist) {
                            minDist = dist;
                            colIndex = idx;
                        }
                    });
                    
                    if (cells[colIndex]) {
                        cells[colIndex] += ' ' + item.text;
                    } else {
                        cells[colIndex] = item.text;
                    }
                });

                return cells.map(cell => cell.trim());
            });

            // Filter out empty rows
            const filteredData = tableData.filter(row => 
                row.some(cell => cell.length > 0)
            );

            if (filteredData.length < 2) return [];

            return [{
                page: pageNum,
                data: filteredData,
                columns: columnPositions.length
            }];
        }

        function detectColumns(rows) {
            // Collect all X positions
            const xPositions = [];
            rows.forEach(row => {
                row.forEach(item => {
                    xPositions.push(item.x);
                });
            });

            if (xPositions.length === 0) return [];

            // Cluster X positions into columns
            xPositions.sort((a, b) => a - b);
            
            const columns = [];
            let currentCluster = [xPositions[0]];
            const threshold = 20; // Pixels tolerance for column grouping

            for (let i = 1; i < xPositions.length; i++) {
                if (xPositions[i] - xPositions[i - 1] < threshold) {
                    currentCluster.push(xPositions[i]);
                } else {
                    columns.push(currentCluster.reduce((a, b) => a + b, 0) / currentCluster.length);
                    currentCluster = [xPositions[i]];
                }
            }
            columns.push(currentCluster.reduce((a, b) => a + b, 0) / currentCluster.length);

            return columns;
        }

        function renderPreview() {
            previewHead.innerHTML = '';
            previewBody.innerHTML = '';

            if (extractedData.length === 0) return;

            const previewRows = extractedData.slice(0, 10);
            const maxCols = Math.max(...previewRows.map(r => r ? r.length : 0));

            // Create header
            const headerRow = document.createElement('tr');
            if (extractedData[0]) {
                extractedData[0].forEach((_, i) => {
                    const th = document.createElement('th');
                    th.textContent = `Column ${i + 1}`;
                    headerRow.appendChild(th);
                });
            }
            previewHead.appendChild(headerRow);

            // Create body rows
            previewRows.forEach(row => {
                if (!row || row.length === 0) return;
                
                const tr = document.createElement('tr');
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell || '';
                    tr.appendChild(td);
                });
                previewBody.appendChild(tr);
            });

            document.getElementById('previewInfo').textContent = 
                `Showing first ${Math.min(10, extractedData.length)} of ${extractedData.length} rows`;
        }

        function downloadExcel() {
            if (extractedData.length === 0) return;

            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Create worksheet from data
            const ws = XLSX.utils.aoa_to_sheet(extractedData);
            
            // Set column widths
            const colWidths = [];
            extractedData.forEach(row => {
                if (row) {
                    row.forEach((cell, i) => {
                        const len = (cell || '').toString().length;
                        colWidths[i] = Math.max(colWidths[i] || 10, len + 2);
                    });
                }
            });
            ws['!cols'] = colWidths.map(w => ({ wch: Math.min(w, 50) }));

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Extracted Data');

            // Generate and download file
            XLSX.writeFile(wb, `${currentFileName}_converted.xlsx`);
        }

        function updateProgress(percent, status) {
            progressBar.style.width = `${percent}%`;
            progressPercent.textContent = `${Math.round(percent)}%`;
            progressStatus.textContent = status;
        }

        function showSection(section) {
            uploadSection.classList.add('hidden');
            processingSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            errorSection.classList.add('hidden');

            switch (section) {
                case 'upload':
                    uploadSection.classList.remove('hidden');
                    break;
                case 'processing':
                    processingSection.classList.remove('hidden');
                    break;
                case 'results':
                    resultsSection.classList.remove('hidden');
                    break;
                case 'error':
                    errorSection.classList.remove('hidden');
                    break;
            }
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            showSection('error');
        }

        function resetApp() {
            extractedData = [];
            currentFileName = 'document';
            fileInput.value = '';
            progressBar.style.width = '0%';
            progressPercent.textContent = '0%';
            progressStatus.textContent = 'Initializing...';
            previewHead.innerHTML = '';
            previewBody.innerHTML = '';
            showSection('upload');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function animateNumber(element, target) {
            const duration = 1000;
            const start = parseInt(element.textContent) || 0;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const current = Math.round(start + (target - start) * easeOut);
                
                element.textContent = current.toLocaleString();

                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }

            requestAnimationFrame(update);
        }
    </script>
</body>
</html>